<html>
<head><title>HM-SURF</title></head>
<body>
<video id="player" autoplay muted playsinline></video>
<canvas id="canvas" width=320 height=240></canvas>
<script>

    // Get elements
    const player = document.getElementById('player');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    // Video settings
    const constraints = {
        video: {
            facingMode: {
                exact: 'environment'
            }
        }
    };

    // Gets the position
    function getPosition(options?: PositionOptions): Promise<Position> {
        return new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, options));
    }

    // Gets the filename
    function getFilename() {

        // The base filename
        let baseFilename = 'hm_surf';

        // Derive location
        if (navigator.geolocation) {
            getPosition(options).then((position) => { baseFilename += '_' + position.coords.latitude.toString() + '_' + position.coords.longitude.toString() });
        }

        // Return the filename with the right extension
        return baseFilename + '.png';
    }

    // Takes the snapshot
    function snap() {
        
        // Draw the image
        context.drawImage(player, 0, 0, canvas.width, canvas.height);

        // Save as image
        var image = canvas.toDataURL();

        // Create download link
        var downloadLink = document.createElement('a');
        downloadLink.download = getFilename();
        downloadLink.href = image;

        // Click the link
        downloadLink.click();

        // Pause video
        player.pause();

        // Clear canvas
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Take snapshot when video starts playing
    player.oncanplay = snap;

    // Trigger
    navigator.mediaDevices.getUserMedia(constraints)
        .then((stream) => {
            player.srcObject = stream;
        });
</script>
</body>
</html>
